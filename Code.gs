const GEMINI_API_KEY = "GEMINI_API_KEY"; // ‡πÉ‡∏™‡πà GEMINI_API_KEY ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
const MODEL_NAME = "gemini-3-flash-preview"; 
const SHEET_ID = "1edSe8hdjaUFc34gN2MPkQBIhKmtDtdmlamMa5x2dVgU"; 

function doGet() {
  return HtmlService.createHtmlOutputFromFile('Index')
         .setTitle('MindBeat - Turn Your Life into Lyrics')
         .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

function askGemini(userMessage, base64Image, selectedLang) {
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${GEMINI_API_KEY}`;

  // Logic ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÅ‡∏ö‡∏ö Mirroring
  let langRule = (base64Image && !userMessage) 
    ? `The user sent an image. Please respond in ${selectedLang === 'TH' ? 'Thai' : 'English'}.`
    : `Identify the language of the User Message and respond in that SAME language. If mixed, use a natural bilingual flow.`;
  const systemInstruction = `
Role: ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "MindBeat" ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏Å‡∏±‡∏•‡∏¢‡∏≤‡∏ì‡∏°‡∏¥‡∏ï‡∏£‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏á ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ö‡∏ó‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏±‡∏Å‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏û‡∏•‡∏á Modern Pop ‡∏°‡∏∑‡∏≠‡∏´‡∏ô‡∏∂‡πà‡∏á
‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà: ‡∏£‡∏±‡∏ö‡∏ü‡∏±‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß (‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°/‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û/‡πÄ‡∏™‡∏µ‡∏¢‡∏á) ‡πÅ‡∏•‡∏∞‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏†‡∏≤‡∏û‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏™‡∏ï‡∏¥ ‡∏ï‡∏≤‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏¥‡∏ó‡∏ó‡∏µ‡πà‡∏£‡∏π‡πâ‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö:
1. ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏á "‡∏ó‡πà‡∏≠‡∏ô‡∏Æ‡∏∏‡∏Å" ‡∏™‡∏±‡πâ‡∏ô‡πÜ (Chorus) ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏™‡∏•‡∏∞‡∏™‡∏•‡∏ß‡∏¢ ‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏°‡∏µ‡∏ó‡∏≥‡∏ô‡∏≠‡∏á‡πÉ‡∏ô‡∏´‡∏±‡∏ß
2. ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå: Modern Pop (‡∏ü‡∏±‡∏á‡∏á‡πà‡∏≤‡∏¢, ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÉ‡∏à, ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡πÇ‡∏ö‡∏£‡∏≤‡∏ì)
3. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö! ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß "4 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÅ‡∏•‡∏∞ "‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 200 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡∏à‡∏ö‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà 4 ‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢ ‡πÇ‡∏î‡∏¢‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏±‡∏î‡∏à‡∏ö‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏±‡∏ô)
4. ‡∏Å‡∏≤‡∏£‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á: ‡∏°‡∏µ‡∏™‡∏ï‡∏¥ ‡πÑ‡∏°‡πà‡∏ü‡∏π‡∏°‡∏ü‡∏≤‡∏¢ ‡πÑ‡∏°‡πà‡πÇ‡∏•‡∏Å‡∏™‡∏ß‡∏¢‡∏à‡∏ô‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏ô
5. ‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å: ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÇ‡∏•‡∏Å ‡∏ñ‡πà‡∏≤‡∏¢‡∏ó‡∏≠‡∏î‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏û‡∏•‡∏á
Tone of voice:
- ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á: ‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô ‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏à ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢
- ‡∏£‡∏π‡πâ‡πÉ‡∏à: "‡∏î‡∏±‡∏Å‡∏ó‡∏≤‡∏á" ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ ‡πÄ‡∏ä‡πà‡∏ô "‡πÅ‡∏≠‡∏ö‡∏ô‡∏≠‡∏¢‡∏î‡πå‡∏•‡πà‡∏∞‡∏™‡∏¥" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏£‡∏π‡πâ‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏£‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡∏ô‡∏≤‡∏ô"
- ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏à: ‡∏ú‡∏¥‡∏î‡∏Å‡πá‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏ú‡∏¥‡∏î‡πÅ‡∏ö‡∏ö‡∏ã‡∏≠‡∏ü‡∏ï‡πå‡πÜ ‡πÑ‡∏°‡πà‡∏™‡∏õ‡∏≠‡∏¢‡∏•‡πå‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ó‡∏¥‡πâ‡∏á‡∏Å‡∏±‡∏ô
‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å:
1. No Toxic Positivity: ‡∏´‡πâ‡∏≤‡∏°‡∏ö‡∏≠‡∏Å‡πÉ‡∏´‡πâ "‡∏¢‡∏¥‡πâ‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ß‡πâ" ‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏¢‡πà ‡πÉ‡∏´‡πâ‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ß‡πà‡∏≤‡∏°‡∏±‡∏ô‡πÅ‡∏¢‡πà
2. Fact vs. Emotion: ‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏¢‡∏Å‡πÅ‡∏¢‡∏∞ "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á" ‡∏Å‡∏±‡∏ö "‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏ï‡πà‡∏á"
3. The Reality Check: ‡πÉ‡∏´‡πâ‡πÅ‡∏á‡πà‡∏Ñ‡∏¥‡∏î‡∏ö‡∏ô‡πÇ‡∏•‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á (‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á, ‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î)
4. Multi-language Support: ${langRule}
Constraint: ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏¥‡∏ï‡πÄ‡∏ß‡∏ä‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡∏´‡∏≤‡∏Å‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏†‡∏≤‡∏û`;

  let parts = [{ "text": systemInstruction + "\n\nUser Message: " + userMessage }];
  if (base64Image) {
    parts.push({ "inline_data": { "mime_type": "image/jpeg", "data": base64Image } });
  }
  const payload = { 
    "contents": [{ "parts": parts }], 
    "generationConfig": { "temperature": 0.8, "maxOutputTokens": 3000 } 
  };
  const options = { "method": "post", "contentType": "application/json", "payload": JSON.stringify(payload), "muteHttpExceptions": true };

  try {
    const response = UrlFetchApp.fetch(url, options);
    const json = JSON.parse(response.getContentText());
    return json.candidates[0].content.parts[0].text;
  } catch (e) {
    if (selectedLang === 'EN') {
      return "Life's beat skipped a bit. Try again, friend!";
    } else {
      return "‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏™‡∏∞‡∏î‡∏∏‡∏î‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏ô‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô";
    }
  }
}

function saveToAll(userMessage, aiHook, selectedLang) { // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå selectedLang
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const sheet = ss.getSheets()[0];
    sheet.appendRow([new Date(), userMessage, aiHook]);
    const calendar = CalendarApp.getDefaultCalendar();
    calendar.createAllDayEvent("üéµ MindBeat: " + aiHook, new Date(), { description: "User: " + userMessage });
    
    // ‡∏õ‡∏£‡∏±‡∏ö Logic ‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    if (selectedLang === 'EN') {
      return "Memory saved successfully, friend! ‚ú®";
    } else {
      return "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô! ‚ú®";
    }
    
  } catch (e) {
    return (selectedLang === 'EN' ? "System error: " : "‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á: ") + e.toString();
  }
}
